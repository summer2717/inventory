<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cupicho æ™ºæ…§ç›¤é»ç³»çµ± V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        #reader { border: 2px solid #334155 !important; border-radius: 12px; overflow: hidden; }
        .flash-success { animation: flash 0.4s ease-out; }
        @keyframes flash {
            0% { box-shadow: inset 0 0 100px rgba(16, 185, 129, 0.8); }
            100% { box-shadow: inset 0 0 0px transparent; }
        }
    </style>
</head>
<body class="p-4 font-sans max-w-md mx-auto min-h-screen">

    <div id="flash-overlay" class="fixed inset-0 pointer-events-none z-50"></div>

    <header class="mb-4 text-center">
        <h1 class="text-2xl font-bold text-yellow-500 tracking-wider italic">CUPICHO</h1>
        <p class="text-slate-400 text-[10px] uppercase tracking-widest">Advanced Inventory Solution</p>
    </header>

    <div id="reader" class="mb-4 bg-slate-800 shadow-2xl"></div>

    <section class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg mb-4">
        <div id="product-info" class="mb-3 text-center py-2 border-b border-slate-700">
            <div id="display-name" class="text-lg font-bold text-white mt-1">ç­‰å¾…æƒæä¸­...</div>
            <div id="display-id" class="text-sm text-yellow-500 font-mono">ID: ----</div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-4">
            <input type="text" id="barcode-input" class="col-span-2 bg-slate-900 border border-slate-600 rounded-lg p-3 text-lg focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="æ¢ç¢¼ç·¨è™Ÿ">
            <input type="number" id="qty-input" value="1" class="col-span-1 bg-slate-900 border border-slate-600 rounded-lg p-3 text-2xl font-bold text-center text-yellow-400 outline-none">
            <button onclick="addEntry()" class="col-span-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-lg active:scale-95 transition-all shadow-lg text-lg">ç¢ºèªé€å‡º</button>
        </div>
        
        <button id="search-trigger" onclick="openSearch()" class="hidden w-full mt-3 py-3 text-sm text-blue-400 border border-blue-900 rounded-lg bg-blue-900/30 font-medium">
            ğŸ” æª”æ¡ˆä¸­ç„¡æ­¤æ¢ç¢¼ï¼Ÿé»æ­¤æœå°‹å“åç¶å®š
        </button>
    </section>

    <section class="mb-24">
        <div class="flex justify-between items-center mb-3 px-1">
            <h2 class="text-lg font-bold border-l-4 border-yellow-600 pl-2">ç›¤é»ç´€éŒ„</h2>
            <button onclick="exportCSV()" class="text-xs bg-emerald-700 hover:bg-emerald-600 px-3 py-1.5 rounded-full text-white font-bold transition-colors">åŒ¯å‡º CSV</button>
        </div>
        <div id="inventory-list" class="space-y-2 text-sm"></div>
    </section>

    <div class="fixed bottom-4 left-4 right-4 max-w-md mx-auto flex gap-2 z-40">
        <button onclick="clearData()" class="bg-slate-800 border border-slate-700 text-slate-500 px-4 py-3 rounded-xl text-xs active:bg-red-900">æ¸…ç©º</button>
        <div class="flex-1 bg-slate-800/90 backdrop-blur border border-slate-700 p-3 rounded-xl flex justify-between items-center px-6 shadow-2xl">
            <span class="text-slate-400 text-sm">å·²ç›¤ç¸½å“é …</span>
            <span id="total-count" class="text-xl font-bold text-white">0</span>
        </div>
    </div>

    <div id="search-modal" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col p-4 animate-in fade-in duration-200">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white">æœå°‹ä¸¦ç¶å®šå•†å“</h3>
            <button onclick="closeSearch()" class="text-3xl p-2">&times;</button>
        </div>
        <input type="text" id="master-search-input" oninput="filterMaster()" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-4 mb-4 outline-none focus:border-yellow-500 text-lg" placeholder="è¼¸å…¥è²¨è™Ÿæˆ–å“åé—œéµå­—...">
        <div id="master-results" class="flex-1 overflow-y-auto space-y-2 pb-10"></div>
    </div>

    <script>
        /** è‡ªå‹•ç”Ÿæˆçš„å•†å“ä¸»æª” **/
        const masterData = [
            { id: "M01", barcode: "4710123456789", name: "Cupicho 70% è‹¦ç”œå·§å…‹åŠ›" },
            { id: "M02", barcode: "4710987654321", name: "æ¯”åˆ©æ™‚ç„¦ç³–è„†é¤…" },
            { id: "M03", barcode: "88888888", name: "ç¶“å…¸å¨å£«å¿Œç¦®ç›’" }
            // æ‚¨å¯ä»¥å°‡ Excel å…§å®¹è½‰ç‚ºä¸Šè¿°æ ¼å¼å¾Œè²¼åœ¨é€™è£¡
        ];

        let manualMappings = JSON.parse(localStorage.getItem('cupicho_mappings')) || {};
        let inventory = JSON.parse(localStorage.getItem('cupicho_inventory')) || [];
        
        const barcodeInput = document.getElementById('barcode-input');
        const qtyInput = document.getElementById('qty-input');
        const displayName = document.getElementById('display-name');
        const displayId = document.getElementById('display-id');
        const searchBtn = document.getElementById('search-trigger');

        // åˆå§‹åŒ–æƒæå™¨
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: {width: 280, height: 160} }, onScanSuccess);

        function onScanSuccess(text) {
            playFeedback();
            barcodeInput.value = text;
            processBarcode(text);
            qtyInput.focus();
            qtyInput.select();
        }

        function processBarcode(code) {
            let item = masterData.find(m => m.barcode === code) || manualMappings[code];
            
            if (item) {
                displayName.innerText = item.name;
                displayId.innerText = `è²¨è™Ÿ: ${item.id}`;
                displayName.classList.remove('text-red-400');
                searchBtn.classList.add('hidden');
            } else {
                displayName.innerText = "âš ï¸ ä¸»æª”ç„¡æ­¤æ¢ç¢¼";
                displayName.classList.add('text-red-400');
                displayId.innerText = "è«‹æ‰‹å‹•æœå°‹å“åé€²è¡Œç¶å®š";
                searchBtn.classList.remove('hidden');
            }
        }

        function addEntry() {
            const code = barcodeInput.value.trim();
            const qty = parseInt(qtyInput.value);
            if(!code || isNaN(qty)) return;

            let item = masterData.find(m => m.barcode === code) || manualMappings[code] || { id: "UNKNOWN", name: "æœªç¶å®šå•†å“" };

            const idx = inventory.findIndex(i => i.barcode === code);
            if (idx > -1) {
                inventory[idx].qty += qty;
                inventory[idx].time = new Date().toLocaleTimeString();
            } else {
                inventory.unshift({ id: item.id, barcode: code, name: item.name, qty: qty, time: new Date().toLocaleTimeString() });
            }
            saveAndRender();
            resetInputs();
        }

        // --- æœå°‹ç¶å®šåŠŸèƒ½ ---
        function openSearch() {
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('master-search-input').focus();
            filterMaster();
        }

        function closeSearch() { document.getElementById('search-modal').classList.add('hidden'); }

        function filterMaster() {
            const query = document.getElementById('master-search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('master-results');
            resultsDiv.innerHTML = '';

            const filtered = masterData.filter(m => m.name.toLowerCase().includes(query) || m.id.toLowerCase().includes(query));
            
            filtered.slice(0, 50).forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 active:bg-yellow-900 flex justify-between items-center";
                div.innerHTML = `<div><div class="font-bold text-white">${item.name}</div><div class="text-xs text-slate-500">${item.id}</div></div><div class="text-blue-400 text-xs font-bold">é¸æ“‡</div>`;
                div.onclick = () => {
                    manualMappings[barcodeInput.value] = item;
                    localStorage.setItem('cupicho_mappings', JSON.stringify(manualMappings));
                    closeSearch();
                    processBarcode(barcodeInput.value);
                };
                resultsDiv.appendChild(div);
            });
        }

        // --- æ ¸å¿ƒå·¥å…· ---
        function playFeedback() {
            const overlay = document.getElementById('flash-overlay');
            overlay.classList.add('flash-success');
            setTimeout(() => overlay.classList.remove('flash-success'), 400);
            
            // Beep Sound
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value = 1000; gain.gain.value = 0.1;
            osc.start(); osc.stop(ctx.currentTime + 0.1);

            if (navigator.vibrate) navigator.vibrate(100);
        }

        function saveAndRender() {
            localStorage.setItem('cupicho_inventory', JSON.stringify(inventory));
            const container = document.getElementById('inventory-list');
            container.innerHTML = '';
            inventory.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = "bg-slate-800/60 p-3 rounded-lg border border-slate-700 flex justify-between items-center shadow-sm";
                el.innerHTML = `
                    <div class="flex-1 pr-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] bg-slate-700 px-1 rounded text-yellow-500 font-mono">${item.id}</span>
                            <span class="font-bold text-slate-100 truncate max-w-[150px] inline-block">${item.name}</span>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-1">${item.barcode} | ${item.time}</div>
                    </div>
                    <div class="text-xl font-black text-yellow-500 w-12 text-center">${item.qty}</div>
                    <button onclick="deleteItem(${idx})" class="text-slate-500 px-2 text-xl">&times;</button>
                `;
                container.appendChild(el);
            });
            document.getElementById('total-count').innerText = inventory.length;
        }

        function resetInputs() {
            barcodeInput.value = ""; qtyInput.value = "1";
            displayName.innerText = "ç­‰å¾…æƒæä¸­..."; displayId.innerText = "ID: ----";
            searchBtn.classList.add('hidden');
        }

        function deleteItem(idx) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { inventory.splice(idx, 1); saveAndRender(); } }
        function clearData() { if(confirm("ğŸš¨ æ³¨æ„ï¼šé€™å°‡æ¸…ç©ºæ‰€æœ‰æ‰‹æ©Ÿç›¤é»ç´€éŒ„ï¼")) { inventory = []; saveAndRender(); } }

        function exportCSV() {
            if(inventory.length === 0) return alert("å°šç„¡è³‡æ–™");
            let csv = "\ufeffè²¨è™Ÿ,å“å,æ¢ç¢¼,æ•¸é‡,æœ€å¾Œç›¤é»æ™‚é–“\n";
            inventory.forEach(i => csv += `"${i.id}","${i.name}","${i.barcode}",${i.qty},"${i.time}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Cupicho_Inventory_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        saveAndRender();
    </script>
</body>
</html>
