<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CUPICHO DEBUG V3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; }
        .modal-view { display: flex !important; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; flex-direction: column; padding: 20px; }
        #debug-console { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; height: 60px; overflow-y: auto; border-top: 1px solid #333; }
    </style>
</head>
<body class="p-4 font-sans max-w-md mx-auto min-h-screen pb-32">

    <header class="mb-4 flex justify-between items-center">
        <h1 class="text-2xl font-black text-yellow-500 italic">CUPICHO</h1>
        <button id="admin-btn" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold border border-slate-700">âš™ï¸ ç®¡ç†ä¸»æª”</button>
    </header>

    <div id="reader-wrapper" class="relative bg-slate-900 rounded-2xl overflow-hidden mb-4 border border-slate-800" style="min-height: 250px;">
        <div id="reader"></div>
        <div id="placeholder" class="absolute inset-0 flex items-center justify-center bg-slate-900 z-10">
            <button id="start-btn" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-2xl">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
    </div>

    <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800 mb-4 shadow-xl text-center">
        <div id="display-name" class="text-lg font-bold mb-1">ç­‰å¾…æŒ‡ä»¤...</div>
        <div id="display-id" class="text-xs text-yellow-600 font-mono mb-4 uppercase tracking-widest">---</div>
        
        <div class="grid grid-cols-3 gap-2">
            <input type="text" id="barcode-input" class="col-span-2 bg-black border border-slate-700 rounded-xl p-4 text-white font-mono" placeholder="æ¢ç¢¼">
            <input type="number" id="qty-input" value="1" class="bg-black border border-slate-700 rounded-xl p-4 text-2xl font-black text-center text-yellow-500">
            <button id="submit-btn" class="col-span-3 bg-yellow-500 text-black py-4 rounded-xl font-black text-lg">ç¢ºèªé€å‡º</button>
        </div>
    </div>

    <div id="inventory-list" class="space-y-2 mb-20"></div>

    <div id="admin-modal" class="hidden modal-view">
        <div class="flex justify-between mb-4">
            <h2 class="text-xl font-bold">âš™ï¸ å•†å“ç®¡ç†</h2>
            <button id="close-admin" class="text-3xl">&times;</button>
        </div>
        <div class="space-y-3 mb-6 bg-slate-900 p-4 rounded-xl">
            <input type="text" id="new-id" class="w-full bg-black border border-slate-700 p-3 rounded text-sm" placeholder="è²¨è™Ÿ">
            <input type="text" id="new-barcode" class="w-full bg-black border border-slate-700 p-3 rounded text-sm" placeholder="æ¢ç¢¼">
            <input type="text" id="new-name" class="w-full bg-black border border-slate-700 p-3 rounded text-sm" placeholder="å“å">
            <button id="save-master" class="w-full bg-emerald-600 py-3 rounded font-bold">æ–°å¢è‡³è³‡æ–™åº«</button>
        </div>
        <div id="local-list" class="flex-1 overflow-y-auto space-y-2 text-xs"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-[1000]">
        <div id="debug-console">ç³»çµ±è¨ºæ–·ä¸­...</div>
    </div>

    <script>
        // --- è¨ºæ–·å·¥å…· ---
        const log = (msg) => {
            const el = document.getElementById('debug-console');
            el.innerHTML += `<div>> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        };
        window.onerror = (m, u, l) => log(`éŒ¯èª¤: ${m} at line ${l}`);

        // --- è³‡æ–™ ---
        const masterData = [
            {"id": "46", "barcode": "8026861046751", "name": "Domori 70%å·§å…‹åŠ›"},
            {"id": "752", "barcode": "5000277003280", "name": "å¸ç‹ 15å¹´å¨å£«å¿Œ"}
        ];
        let inventory = JSON.parse(localStorage.getItem('cup_inv')) || [];
        let localMaster = JSON.parse(localStorage.getItem('cup_local_master')) || [];
        let scanner;

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            log("é é¢è¼‰å…¥æˆåŠŸ");
            renderInventory();
            
            // ç¶å®šäº‹ä»¶ (ä¸ä½¿ç”¨ HTML å…§çš„ onclickï¼Œæ”¹ç”¨ JavaScript ç¶å®šæ›´ç©©å®š)
            document.getElementById('start-btn').addEventListener('click', startCam);
            document.getElementById('admin-btn').addEventListener('click', () => {
                log("é–‹å•Ÿç®¡ç†ä»‹é¢");
                document.getElementById('admin-modal').classList.add('modal-view');
                renderLocalMaster();
            });
            document.getElementById('close-admin').addEventListener('click', () => {
                document.getElementById('admin-modal').classList.remove('modal-view');
            });
            document.getElementById('submit-btn').addEventListener('click', addItem);
            document.getElementById('save-master').addEventListener('click', saveNewMaster);
        };

        // --- ç›¸æ©Ÿæ§åˆ¶ ---
        async function startCam() {
            log("å˜—è©¦å•Ÿå‹•ç›¸æ©Ÿ...");
            try {
                scanner = new Html5Qrcode("reader");
                await scanner.start(
                    { facingMode: "environment" },
                    { fps: 15, qrbox: 250 },
                    (text) => {
                        log("æƒææˆåŠŸ: " + text);
                        document.getElementById('barcode-input').value = text;
                        checkItem(text);
                    }
                );
                document.getElementById('placeholder').style.display = 'none';
                log("ç›¸æ©Ÿå·²å•Ÿå‹•");
            } catch (e) {
                log("ç›¸æ©ŸéŒ¯èª¤: " + e);
                alert("ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€ç‚º HTTPS ä¸”å·²å…è¨±æ¬Šé™");
            }
        }

        // --- é‚è¼¯ ---
        function checkItem(code) {
            const all = [...masterData, ...localMaster];
            const found = all.find(i => String(i.barcode) === code);
            const nameEl = document.getElementById('display-name');
            const idEl = document.getElementById('display-id');
            if(found) {
                nameEl.innerText = found.name;
                idEl.innerText = "ID: " + found.id;
                nameEl.classList.remove('text-red-500');
            } else {
                nameEl.innerText = "âš ï¸ æ‰¾ä¸åˆ°å•†å“";
                idEl.innerText = code;
                nameEl.classList.add('text-red-500');
            }
        }

        function addItem() {
            const code = document.getElementById('barcode-input').value;
            const qty = parseInt(document.getElementById('qty-input').value);
            if(!code || !qty) return log("æ¬„ä½ç©ºç™½");
            
            const all = [...masterData, ...localMaster];
            const item = all.find(i => String(i.barcode) === code) || { id: "NEW", name: "æœªçŸ¥å•†å“" };
            
            inventory.unshift({ ...item, barcode: code, qty, time: new Date().toLocaleTimeString() });
            localStorage.setItem('cup_inv', JSON.stringify(inventory));
            renderInventory();
            log("æ–°å¢ç›¤é»: " + item.name);
            document.getElementById('barcode-input').value = "";
        }

        function saveNewMaster() {
            const id = document.getElementById('new-id').value;
            const barcode = document.getElementById('new-barcode').value;
            const name = document.getElementById('new-name').value;
            if(!id || !barcode || !name) return alert("è«‹å¡«å…¨");
            localMaster.unshift({ id, barcode, name });
            localStorage.setItem('cup_local_master', JSON.stringify(localMaster));
            renderLocalMaster();
            log("è³‡æ–™åº«å·²æ–°å¢: " + name);
        }

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = inventory.map(i => `
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between">
                    <div><b>${i.name}</b><br><small class="text-slate-500">${i.barcode}</small></div>
                    <div class="text-yellow-500 font-bold text-xl">${i.qty}</div>
                </div>
            `).join('');
        }

        function renderLocalMaster() {
            const list = document.getElementById('local-list');
            list.innerHTML = localMaster.map(m => `
                <div class="p-2 border-b border-slate-800">${m.name} (${m.id})</div>
            `).join('');
        }
    </script>
</body>
</html>
